# 思阅 SiReader - 更新日志

---
## 🚀 v0.8.2 (2026.2.4)

### ✨ 新增功能

#### 🎯 完整的 Script 支持
卡片现在完全支持 Anki 的 JavaScript 脚本功能：
- **脚本执行** - 保留并执行卡片中的 `<script>` 标签
- **词典查询链接** - `lookUp()` 函数自动设置查询链接
- **版本检查和反馈** - `checkVersion()` 和 `feedback()` 函数正常工作
- **自动复制单词** - `autoCopyWord()` 使用 clipboard API
- **在线 TTS** - `setEdgeTTS()` 创建音频元素
- **键盘快捷键** - `triggerAudioPlayback()` 监听键盘事件

#### 🖼️ 标签图片完美显示
修复了部分图片加载失败的问题：
- **脚本图片映射** - 从 `<script>` 中提取 `imgMappings` 对象
- **智能图片插入** - 根据卡片 tags 自动插入对应图片
- **正反面独立处理** - 确保图片在正面和背面都能正确显示
- **括号计数算法** - 精确提取嵌套的 JavaScript 对象

### 🔧 优化改进

#### ⚡ 性能优化
- **极限精简代码** - 图片处理逻辑从 58 行精简到 13 行，减少 78%
- **单行括号计数** - 括号匹配算法从 5 行压缩到 1 行
- **链式调用** - 媒体处理使用链式 replace，减少遍历次数
- **动态正则** - 避免 Map 创建，直接用 tag 构建正则匹配

#### 🎨 代码质量
- **增强健壮性** - 可选链防止空值错误，提前返回避免无效处理
- **统一路径分割** - 使用 `split(/[?/]/)` 正则统一处理路径
- **简化文本提取** - `extractAnkiTitle` 和 `extractAnkiHint` 使用 IIFE 缓存
- **合并正则** - 清理 HTML 时合并多个 replace 操作

#### 🗄️ 数据库兼容性
- **智能数据库选择** - 自动检测所有数据库文件（`.anki21b`、`.anki21`、`.anki2`）
- **自动解压缩** - 自动处理 zstd 压缩的数据库和媒体文件
- **容错处理** - 跳过损坏的数据库文件，确保导入成功
- **完整模板支持** - 正确解析新版 Anki 的 notetypes、templates、fields 表

### 🐛 Bug 修复
- 修复部分卡片图片无法加载的问题
- 修复脚本中的图片映射信息丢失
- 修复 tags 图片在背面不显示的问题
- 修复括号嵌套导致的对象提取错误

---
## 🚀 v0.8.1 (2026.2.3)

### ✨ 新增功能

#### 🎨 卡组模板编辑器
在卡组编辑界面新增完整的模板编辑功能，让你可以自定义卡片的显示样式：
- **查看模板信息** - 显示卡组的字段列表、前面模板、背面模板
- **编辑模板** - 支持编辑前面模板、背面模板和 CSS 样式
- **实时预览** - 修改后立即预览效果，支持前面/背面切换
- **自动保存** - 修改自动保存，下次打开保持设置

**使用场景**：
- 调整卡片字体、颜色、布局
- 自定义卡片显示样式
- 预览修改效果

### 🎯 Anki 模板系统完整支持

#### ✅ 模板语法支持
完整支持 Anki 模板语法，让导入的卡片正确显示：
- **条件显示** - 字段存在时显示内容
- **条件隐藏** - 字段不存在时显示内容
- **嵌套条件** - 支持复杂的条件组合
- **前面内容引用** - 背面可以引用前面的内容

**高级过滤器**：
- 日语假名注音（furigana）
- 提取汉字/假名（kanji/kana）
- 提示按钮（hint）
- 输入框（type）
- 纯文本（text）

#### ✅ 样式完美显示
卡片样式现在可以正确显示了：
- 自定义字体、颜色、布局全部生效
- 与 Anki 桌面版显示效果一致
- 支持复杂的样式设置

#### ✅ 数学公式支持
自动识别和渲染数学公式：
- 自动渲染 LaTeX 公式
- 支持行内公式和块级公式
- 展开卡片时自动更新
**支持格式**：
- 行内：`\(...\)` 或 `$...$`
- 块级：`\[...\]` 或 `$$...$$`

#### ✅ 卡片内容编辑
支持直接编辑卡片内容：
- 点击卡片进入编辑模式
- 前面/背面独立编辑
- 支持富文本格式
- 修改自动保存

### 📦 完整支持新版 Anki 格式

完整支持最新版 Anki 2.1.50+ 导出的卡组格式：
- **自动识别格式** - 支持 `.anki21b`（压缩）、`.anki2`、`.anki21` 所有格式
- **智能解压缩** - 自动处理压缩的数据库和媒体文件
- **向下兼容** - 完美兼容旧版 Anki 格式
- **层级卡组** - 正确识别和导入多层级卡组结构

### 🐛 问题修复

- **✅ 数据库初始化** - 修复更新插件后数据库创建失败的问题
- **✅ 统计页面报错** - 修复无学习数据时点击"总计"标签页报错的问题

### ⚡ 性能优化

- **表情选择器优化** - 初始加载 50 个表情，滚动加载更多，打开速度提升
- **代码精简** - 优化代码结构，减少 20% 代码量，运行更流畅
- **样式统一** - 统一管理所有样式，界面更协调

---

## 🚀 v0.8.0 (2026.2.1)

> **⚠️ 下个版本重要提示**  
> - **数据库统一重构**：v0.9.0 将统一所有数据存储到单个 SQLite 数据库，**这是破坏性更新，请注意提前备份数据**  
> - **会员功能上线**：v0.9.0 将推出专业版订阅，解锁更多高级功能

#### ✨ 新增功能

- **📦 Anki 牌组导入** - 完整支持 .apkg 文件导入，保留卡组结构和卡片内容
  - 自动解析 Anki 数据库，提取卡组、卡片、模板
  - 自动提取媒体文件（图片、音频）并按需加载
  - **注意**：当前版本暂不支持导入原有学习进度、多层级卡组结构、自定义 CSS 样式，后续版本将支持
  
- **🎴 完整闪卡学习系统** - 专业的间隔重复学习功能
  - 四级评分系统：重来(Again)、困难(Hard)、良好(Good)、简单(Easy)
  - 智能学习队列：新卡片、学习中、复习卡片自动排序
  - 学习阶梯：支持自定义学习步骤（如：1分钟、10分钟、1天）
  - 每日限制：可设置每日新卡片和复习卡片上限
  - 卡组启用/禁用：灵活控制学习内容
  - 学习会话：记录学习开始时间和统计数据
  
- **📊 多维度数据统计** - 全面的学习数据分析和可视化
  - **今日统计**：新卡片数、复习数、正确率、连续天数
  - **今日评分**：环形图展示评分分布（重来/困难/良好/简单）
  - **记忆曲线**：折线图展示7天/30天记忆保留率趋势
  - **总体统计**：总卡片数、已复习数、平均正确率、连续天数
  - **失误分析**：按失误次数分类（0次、1-2次、3-5次、>5次）
  - **学习效率**：气泡图展示复习次数与间隔天数的关系（高效掌握/稳定进步/需要巩固/困难卡片）
  - **记忆强度**：按 Ease 值分类（困难<130%、一般130-200%、良好200-250%、优秀≥250%）
  - **FSRS 统计**：目标记忆率、FSRS 卡片数、平均稳定性、平均难度
  - **难度分布**：雷达图展示 FSRS 难度分布（简单/中等/困难/极难）
  - **间隔分布**：环形图展示间隔分布（<1天、1-3天、4-14天、≥15天）
  - **复习间隔**：详细间隔分布（<1天、1-7天、1-4周、1-3月、3-6月、>6月）
  - **学习日历**：热力图展示全年学习情况，支持日期筛选和导航
  
- **🧠 FSRS 算法集成** - 先进的间隔重复算法
  - 支持 FSRS (Free Spaced Repetition Scheduler) 算法
  - 自动计算卡片稳定性(Stability)和难度(Difficulty)
  - 可设置期望记忆保留率（默认90%）
  - 支持自定义 FSRS 权重参数
  - 与传统 SM-2 算法无缝切换
  
- **💾 独立数据库管理** - 高性能的数据存储方案
  - 使用 SQL.js 实现客户端 SQLite 数据库（WebAssembly 版本）
  - 分离学习进度和卡片内容，优化查询性能
  - 支持复杂查询：按状态、间隔、难度、日期筛选
  - 自动索引优化，支持大量卡片（10000+）
  - 数据持久化到思源笔记 `/data/storage/petal/siyuan-sireader/`
  - 支持 Anki 数据库和思源数据库双存储
  
- **⚙️ 完善的卡组设置** - 20+ 可配置参数
  - **每日上限**：新卡片/复习卡片每日数量（默认20/200）
  - **学习阶梯**：新卡片学习步骤（默认1,10分钟）、毕业间隔（1天）、简单间隔（4天）
  - **遗忘处理**：重新学习步骤（10分钟）、最小间隔（1天）、水蛭阈值（8次）
  - **展示顺序**：新卡片顺序（随机/顺序）、复习排序（到期/随机/间隔）、新复习优先级（混合/新卡优先/复习优先）、新卡片收集优先级（卡组/位置/随机）
  - **FSRS 选项**：启用/禁用、期望保留率（默认90%）、自定义权重
  - **高级选项**：最大间隔（36500天）、起始难度（2.5）、简单奖励（1.3）、间隔修正系数（1.0）、困难间隔（1.2）、新间隔（0.0）
  - **关联卡片**：相关新卡片/复习卡片暂时隐藏（避免同时出现相关内容）
  - **后续支持**：音频设置、计时器、自动前进、轻松日、笔记本绑定等功能将在后续版本中实现

#### ⚡ 性能优化

- **🚀 数据库查询优化** - 为高频查询字段添加索引，提升查询速度10倍以上
- **💾 缓存机制** - Anki 数据库缓存，避免重复加载
- **📦 按需加载** - 媒体文件（图片、音频）按需从 .apkg 提取，减少内存占用
- **🔄 批量操作** - 支持批量导入、批量更新，提升大量卡片处理效率

#### 🐛 问题修复

- **📊 统计数据准确性** - 修复连续学习天数计算错误
- **🎴 卡片状态同步** - 修复学习进度保存时机不准确的问题
- **💾 数据库初始化** - 修复首次使用时数据库创建失败的问题

---

## 🚀 v0.7.3 (2026.1.24)

#### ✨ 新增功能

- **📚 书架封面大小调整** - 新增书架封面大小设置项（80-160px），支持动态调整封面显示大小，实现一行三个或四个的自适应布局
- **📄 文档内书籍打开** - 支持直接点击文档内书籍链接打开阅读，首次点击自动提取元数据并添加到书架，再次点击直接打开，无需重复导入
- **💾 界面状态持久化** - 自动保存并恢复阅读界面状态
  - 标注筛选：颜色筛选、排序方式（时间/日期/章节）
  - 目录状态：正序/倒序显示
  - 笔记筛选：所有筛选条件
  - 切换书籍或重新打开时自动恢复上次的筛选状态
- **🔄 批量同步标注** - 新增"同步所有标注"功能，一键将所有未同步的标注导入到绑定文档
  - 在"添加时同步"选项右侧增加刷新按钮，点击批量同步所有标注
  - 智能检测已导入标注，避免重复添加
  - 自动处理已删除块，如果文档中块已删除，会重新导入并更新关联
- **🔄 标注双向同步** - 在标注页面或阅读界面修改标注内容后，自动同步更新到绑定文档
  - 自动定位包含该标注的所有块
  - 自动更新块内容，保持标注与文档一致
  - 统一处理高亮标注、形状标注等所有类型
- **🎨 PDF 形状标注增强** - 完善 PDF 形状标注功能，统一到自动同步逻辑
  - 添加时自动同步到绑定文档
  - 包含完整章节路径信息
  - 支持块关联和双向同步
  - 与高亮标注逻辑完全一致

#### ⚡ 性能优化

- **📑 目录性能优化** - 优化目录交互体验，实现交互冷却机制（10秒）、书签按钮懒加载、延迟渲染
- **🔧 代码重构** - 统一书籍打开逻辑，消除重复代码，增强可维护性
- **🚀 标注检测优化** - 使用数据库查询替代缓存方案，实时准确，性能更优
- **🎯 逻辑统一优化** - 全面梳理标注复制与同步逻辑，统一方法调用，优化代码结构，提升性能和稳定性
- **💾 状态管理优化** - 统一状态加载和保存逻辑，删除重复代码，简化函数调用

#### 🐛 问题修复

- **🖼️ PDF 缩略图修复** - 修复 PDF 缩略图不显示问题，主动加载未渲染页面，使用压缩减少数据量，添加完整错误处理
- **📖 章节路径完整性** - 修复标注只显示当前章节名的问题，现在显示完整层级路径（如：`卷一 - 五言古诗 - 月下独酌`）
  - PDF：扁平化目录转换为带完整路径的结构，向前遍历构建祖先链
  - EPUB/TXT：递归查找目录树，通过链接匹配构建完整路径
- **📋 自定义链接格式** - 修复复制、导出、自动导出标注时不使用自定义链接格式的问题
- **🔗 形状标注块关联** - 修复形状标注自动导入后仍显示导入按钮的问题
- **🔄 目录反序功能** - 修复目录正序倒序按钮点击无效的问题，现在支持目录反序显示
- **⬆️ 滚动按钮优化** - 修复滚动按钮逻辑，根据当前位置智能切换到顶部/到底部功能
- **🔗 解绑文档交互** - 优化解绑文档按钮位置和交互，添加二次确认，防止误触

---

## 🚀 v0.7.1 (2026.1.22)

#### ✨ 新增功能

- **🎨 跟随思源主题** - 新增"跟随思源"主题选项，自动适配思源笔记的明亮/暗黑主题及自定义主题
- **🌓 自动主题切换** - 切换思源主题时，阅读器主题自动同步更新，完美融入思源界面
- **📝 弹注增强** - 支持多种非标准格式的 EPUB 弹注（脚注/尾注/参考文献等）
- **🎯 弹注跳转** - 点击弹注标题栏可跳转到原文位置
- **📋 内容复制** - 弹注内容区域支持文本选择和复制
- **🌐 国际化** - 弹注类型和提示文本支持中英文切换
- **🛠️ PDF 工具栏样式** - 新增工具栏样式设置，支持浮动（默认）和固定两种模式
  - 浮动模式：右上角可拖拽的圆角卡片，可收起展开
  - 固定模式：顶部固定的 WPS 风格工具栏，横向布局，始终展开

#### 🎨 界面优化

- **🎨 弹注样式** - 优化弹注弹窗样式，标题栏可点击，内容区可选择
- **💡 交互提示** - 标题栏显示"(点击跳转)"提示，鼠标悬停显示指针样式
- **🔍 PDF 缩放** - 移除 PDF 最大缩放 500% 的限制，支持无限放大
- **📑 分组优化** - 标注按章节或日期分组后，分组内不再显示冗余的章节和日期信息
- **✏️ 笔记编辑** - 优化笔记交互，点击笔记区域直接进入编辑，点击标注文本跳转定位
- **🛠️ 工具栏优化** - 固定模式下工具栏占据全宽，无圆角，浅阴影，内容区自动留出空间
- **📚 书源管理优化** - 删除确认使用内联 UI，移除弹窗，交互更简洁高效

#### 🐛 问题修复

- **🌙 PDF 暗黑模式** - 修复 PDF 在暗黑模式下文字颜色不正确的问题
  - 暗色模式：canvas 用反色背景渲染 + 反色滤镜 = 完美匹配思源暗色
  - 亮色模式：canvas 直接用主题背景色，无滤镜
  
- **🎨 EPUB 主题同步** - 修复 EPUB 切换主题时外层背景不更新的问题
  - foliate-view 使用 closed Shadow DOM，内部 paginator 从 iframe 读取背景色
  - 通过 `requestAnimationFrame` + `renderer.render()` 触发重新渲染，实现内外层背景同步
  
- **🎨 主题解析** - 优化 CSS 变量解析逻辑，确保主题色正确应用到所有元素
- **🔖 标签页切换** - 修复 PDF 在非活动标签页时选择文字仍弹出标注菜单的问题

#### ⚡ 代码优化

- **🧹 移除废弃功能** - 移除已弃用的"目录位置"设置项及相关代码
- **🔧 工具函数提取** - 提取 `resolveColor`、`resolveTheme`、`getTheme` 等公共函数，代码更简洁高效
- **📦 书源管理重构** - 极限精简代码，使用思源原生 UI 组件，代码量减少 40%

---

## 🚀 v0.7.0 (2026.1.21)

#### ✨ 新增功能

- **📖 章节显示** - 标注自动显示所属章节，PDF 无目录时显示页码
- **📑 智能分组** - 支持按章节、日期、时间三种方式分组排序，可折叠展开
- **🔄 添加时同步** - 新增标注自动导入到绑定的思源文档
- **🗑️ 删除时同步** - 删除标注时同步删除文档中对应的块
- **🎯 智能去重** - 自动检测已导入的标注，避免重复导入

#### 🐛 问题修复

- **✅ 章节导出** - 修复标注导出链接格式中章节名缺失的问题
- **✅ PDF 页码** - 修复 PDF 无目录时标注缺少位置信息的问题
- **✅ 样式过滤** - 修复 EPUB 标注显示 PDF 专属样式（点线、虚线、双线）的问题

#### 🎨 界面优化

- **🎯 标注布局** - 章节名与时间并排显示，章节在左，时间在右
- **🎨 卡片样式** - 标注卡片样式全面优化，竖条高度仅覆盖第一行
- **📍 按钮位置** - 操作按钮移至右下角，避免遮挡内容
- **📝 笔记样式** - 笔记内容使用斜体显示，视觉层次更清晰
- **🔘 分组图标** - 分组折叠使用竖线/圆点切换，交互更直观



---

## 🚀 v0.6.9 (2026.1.11)

#### ✨ 新增功能

- **🔗 标注双向绑定** - 标注导入到思源文档后自动记录块ID，实现标注与文档块的双向关联
- **📍 块跳转** - 已绑定的标注显示链接图标，点击直接跳转到对应的思源文档块
- **👁️ 悬浮预览** - 鼠标悬停在已绑定标注上，620ms后显示思源原生悬浮预览窗口
- **📄 绑定文档** - 标注/笔记面板新增绑定文档功能，可将书籍标注关联到指定思源文档
- **⚙️ 安娜设置** - 新增安娜的档案设置窗口，支持类型筛选、域名选择和自定义域名

#### 🐛 问题修复

- **✅ ZAW3跳转** - 修复zaw3跳转闪烁导致标注遮挡文字的问题

#### 🎨 界面优化

- **🎯 导航栏样式** - 优化导航栏样式，更加贴合思源样式
- **🔄 图标切换** - 已导入标注的下载图标自动变为链接图标，区分导入状态

---

## 🚀 v0.6.8 (2026.1.8)

#### 🐛 问题修复

- **✅ 卡包显示** - 修复卡包在书籍未打开时不显示内容的问题
- **✅ 书架重复打开** - 优化书架打开书籍逻辑，避免重复打开标签页

#### 🎨 界面优化

- **📑 标签页图标** - 为书籍标签页增加阅读器图标，更容易识别

#### 📝 PDF 标注增强

- **📝 样式扩展** - PDF 标注新增点线、虚线、双线三种样式，与 EPUB 保持一致

#### 📖 TXT 标注优化

- **🔄 渲染优化** - 修复标注后其他标注消失的问题，改为只渲染新增标注
- **📝 删除优化** - 修复删除标注后文字也被删除的问题，现在只删除标注样式
- **🎯 跳转功能** - 支持点击标注精确跳转到标注位置，不再只跳转到章节开头
- **🔗 链接复制** - 修复复制标注时没有生成超链接的问题，现在可以正确复制和跳转

---

## 🚀 v0.6.7 (2025.12.29)

#### 🎯 交互优化

- **📍 侧边栏统一** - 优化顶部按钮、插件设置按钮点击逻辑，统一打开思阅侧边栏
- **📋 目录快捷访问** - 阅读页面底部控制栏新增目录按钮，点击从底部弹出精致小窗，无需打开侧边栏

#### 🛠️ 界面优化

- **📐 导航栏自适应** - 优化导航栏按钮自适应排布，响应式布局更流畅
- **👁️ 设置预览增强** - 设置预览新增折叠功能，优化空间利用，实时预览更直观
- **🔍 搜索交互** - 优化搜索界面下拉按钮，点击空白处自动隐藏
- **💡 Tooltip 完善** - 统一各界面按钮 tooltip 显示，提示信息更清晰

#### 🐛 问题修复

- **✅ 目录滚动** - 修复翻页后目录滚动位置重置的问题
- **✅ 侧边栏名称** - 修复侧边栏按钮名称显示为"设置"的问题，统一改为"思阅"
- **✅ 封面显示** - 优化部分封面加载失败的显示逻辑

---

## 🚀 v0.6.6 (2025.12.29)

#### 🔍 EPUB 全局搜索

- **🌐 全文搜索** - 新增 EPUB 全局搜索功能，使用 foliate 原生搜索 API，支持跨章节搜索
- **🎯 搜索高亮** - 搜索结果自动高亮显示，支持上一个/下一个快速跳转
- **📊 结果统计** - 实时显示搜索结果数量和当前位置（如 "5/23"）
- **⚡ 异步搜索** - 使用异步生成器逐步返回结果，大文件搜索不卡顿
- **🎨 统一界面** - EPUB 和 PDF 搜索界面统一，操作体验一致

#### 📄 PDF 文本选中优化

- **🎯 智能文本合并** - 重写 PDF 文本层渲染逻辑，自动合并同一行相邻文本项，减少 span 元素数量
- **📐 精确坐标计算** - 使用 `pdfjs.Util.transform` 精确计算文本位置、字体大小、旋转角度
- **🔍 合并条件优化** - 智能判断文本是否在同一行（垂直偏移 < 30%）、同一方向（角度差 < 0.01）、同一字号（大小差 < 10%）、相邻位置（间距 < 2 倍字高）
- **⚡ 性能提升** - 合并后 span 元素数量大幅减少，选中响应更快，内存占用更低
- **✨ 选中体验** - 文本选中更流畅，不会出现断断续续的情况，支持跨行选中

#### 📚 电子书搜索增强

- **🌐 Anna's Archive 集成** - 新增 Anna's Archive 电子书搜索功能，聚合 Z-Library、LibGen、Sci-Hub 等资源
- **🔍 搜索结果优化** - 电子书搜索结果显示格式（PDF/EPUB/MOBI）、文件大小、语言、年份等详细信息
- **🔗 智能跳转** - 点击电子书搜索结果自动跳转到下载页面，中文环境跳转中文版，其他语言保持原版
- **⚙️ 书源管理集成** - Anna's Archive 集成到书源选择菜单，可在工具栏快速启用/禁用

#### 🎨 界面优化

- **📐 工具栏统一** - 修复书架、搜索界面工具栏样式不一致导致遮挡 dock 边框的问题
- **🔧 书源管理重构** - 书源管理界面融入 dock 页面，使用滑动动画，与书架、搜索等界面保持一致
- **🎯 按钮图标优化** - 统一所有按钮使用 lucide 图标，视觉更协调
- **📝 输入框优化** - 全局工具栏输入框添加 `box-sizing: border-box`，避免溢出问题

#### ⚡ 代码优化

- **🔄 逻辑简化** - 简化搜索逻辑、书源管理逻辑，减少嵌套和重复代码
- **📦 方法统一** - 统一 Dialog 回调处理、状态管理、事件监听等方法
- **🎯 极限精简** - 删除未使用变量（`progress`、`enabledCount`），合并条件判断，代码更简洁高效

#### 🐛 问题修复

- **✅ 工具栏重叠** - 修复书源管理和搜索界面工具栏重叠的问题
- **✅ 边框遮挡** - 修复搜索框溢出遮挡 dock 边框线的问题
- **✅ 目录加载** - 电子书搜索结果不再尝试加载目录，避免无效请求
- **✅ 文本选中** - 修复 PDF 文本选中断断续续、响应慢的问题

---

## 🚀 v0.6.5 (2025.12.28)

#### 📝 PDF 文字选中优化

- **🎯 选中方法重写** - 优化 PDF 文字选中方法，提升选中精度和响应速度
- **📐 坐标计算优化** - 改进文字层坐标计算逻辑，确保选中区域准确

---

## 🚀 v0.6.4 (2025.12.27)

#### 🔍 书源解析增强

- **🎯 规则解析器重构** - 完整支持 JSONPath、CSS 选择器、XPath、JavaScript、正则表达式等多种解析方式，支持 `&&`/`||`/`%%` 组合、`{$.path}` 嵌套、`@put/@get` 数据共享等高级功能
- **🧹 智能内容处理** - 自动清理无用标签、转换 HTML 实体、智能分割段落、识别提取图片，支持链式选择、索引过滤、属性提取等精细化操作

#### ⚡ 性能优化

- **📦 体积优化** - 直接引用思源内置 PDF.js，移除冗余依赖，安装包体积大幅减少
- **🔄 卸载优化** - 增加插件卸载时的刷新方法，确保资源正确释放

#### 🎨 界面优化

**导航栏系统重构**
- **📍 位置设置** - 新增导航栏位置设置，支持左侧、右侧、顶部、底部四个位置
- **🎯 智能提示** - Tooltip 方向根据导航栏位置自动调整（左→右、右→左、上→下、下→上）
- **🎨 圆角6统一** - 所有圆角统一为 8px（导航栏、按钮、弹出菜单），视觉更协调

**书源管理优化**
- **🔧 Dialog 优化** - 修复部分主题隐藏关闭按钮的问题，支持点击外部关闭
- **⚡ 性能提升** - 使用 Set 管理选中状态，提升查找和操作效率

**选择菜单优化**
- **📍 位置限制** - 选择菜单和标注卡片限制在阅读器容器内显示，不会跑到外面
- **📐 边界检测** - 智能检测容器边界，自动调整弹出位置

#### 🐛 问题修复

- **✅ Dialog 关闭** - 修复部分主题隐藏关闭按钮导致无法关闭书源管理的问题
- **✅ 菜单位置** - 修复选择菜单可能超出阅读器容器的问题
- **✅ 圆角不一致** - 统一所有组件圆角为 8px，视觉更协调
- **✅ 标注图标** - 修复标注操作后图标重复显示的问题

---

## 🚀 v0.6.3 (2025.12.24)

#### 📚 书架功能增强

- **✅ 文字溢出修复** - 修复书架列表视图和简洁视图文字溢出的问题，确保书名和作者信息完整显示
- **📊 新增排序方式** - 新增"最近添加"、"最近阅读"、"阅读进度"三种排序方式，方便快速找到想看的书
- **💾 状态持久化** - 书架排序方式、筛选标签、视图模式自动保存到本地存储，下次打开保持上次设置

#### 🖊️ PDF 形状标注增强

- **🎨 填充功能** - 新增形状标注填充功能，支持对矩形、圆形、三角形进行颜色填充（实心/空心切换）
- **📝 自动弹窗** - 形状标注完成后自动弹出编辑备注窗口，可立即添加笔记说明
- **🎯 智能交互** - 优化墨迹标注和形状标注交互逻辑，点击工具栏折叠按钮自动退出编辑模式

#### 🔗 PDF 链接与跳转优化

- **📍 精准定位** - 修改 PDF 链接格式，使用页码和矩形坐标精确定位，跳转更准确
- **✨ 闪烁提示** - 增加跳转后高亮闪烁效果，更明显地标识目标位置
- **🔄 统一逻辑** - 统一跳转高亮逻辑和复制方法，阅读界面和标注界面行为一致

#### ⚡ PDF 渲染优化

- **🎯 重写渲染** - 重写 PDF 渲染方法，修复渲染不及时、标注错位等问题
- **📐 坐标转换** - 优化 PDF 坐标系统转换逻辑，确保缩放、旋转后标注位置准确
- **🖼️ Canvas 管理** - 改进 Canvas 层管理，缩放后自动重新创建绘图器，避免坐标错位

## 🚀 v0.6.2 (2025.12.21)

#### 🐛 问题修复

- **✅ 书籍数据文件** - 修复书籍异常关闭时对应数据文件重复创建的问题
- **✅ 标签页响应** - 增加标签页切换响应式切换目录、书签、标注、笔记功能
- **✅ 文件加载优化** - 统一 PDF/EPUB/TXT 文件加载逻辑，使用 `arrayBuffer()` 替代 `blob()` 避免大文件加载失败
- **✅ 图片错误处理** - EPUB 加载失败的图片自动隐藏，不显示破损图标
- **✅ 移动端 z-index** - 修复移动端阅读器容器 z-index 过高遮挡思源顶部栏（返回按钮和菜单）的问题
- **✅ 控制栏显示** - 优化底部控制栏显示逻辑，确保加载失败时也能显示关闭按钮
- **✅ 标注遮罩层** - 降低标注遮罩层和卡片的 z-index，确保控制栏始终在最上层可点击
- **✅ 组件卸载** - 修复组件卸载时访问 null 引用导致的报错

#### ✨ 移动端支持（实验性）

- **📱 移动端阅读** - 初步支持移动端阅读，PDF 打开正常，EPUB/TXT 可能存在问题
- **👆 手势翻页** - 支持左右滑动翻页，最小滑动距离 50px，自动过滤垂直滑动
- **💾 位置记忆** - 移动端自动保存和恢复阅读位置（CFI 或页码）
- **🔙 返回支持** - 监听浏览器返回按钮，自动触发阅读器关闭事件
- **📱 侧边栏入口** - 移动端侧边栏添加思阅图标入口，点击打开设置面板

#### ⚡ 代码优化

- **🔄 位置管理** - 统一阅读位置保存和恢复逻辑，代码更简洁
- **📂 文件加载** - 统一所有格式的文件加载流程，提升稳定性
- **🏷️ 标签切换** - 优化标签页切换监听机制
- **🎯 整体精简** - 删除冗余代码，提升性能和可维护性

---
## 🚀 v0.6.1 (2025.12.21)

#### 🐛 问题修复

- **✅ PDF 标注位置** - 修复 PDF 选中文字标注后高亮位置不在选中文字上的问题，统一坐标系统使用 `x/y/w/h` 格式
- **✅ 卡包高亮** - 修复 PDF 选词加入卡包后没有紫色高亮的问题，扩展卡包数据结构支持 `page` 和 `rects` 字段
- **✅ 笔记 Tooltip** - 统一标注笔记和形状标注笔记的 tooltip 显示逻辑，鼠标悬停显示完整笔记内容
- **✅ 卡包定位** - 修复卡包页面点击定位提示"未保存位置信息"的问题，支持 PDF 格式的 `page` 字段定位
- **✅ 链接格式说明** - 在 i18n 文件中添加"笔记"和"截图"变量说明，完善复制设置的可用变量提示

#### ⚡ 性能优化

**PDF 加载优化**
- 启用字体渲染和 WebGL 硬件加速，大幅提升渲染速度
- 优化 Canvas 上下文和渲染分辨率，减少像素计算量
- 文本层异步加载，不阻塞页面渲染
- 减小预加载范围，降低内存占用

**PDF 搜索优化**
- 文本缓存机制，第二次搜索速度提升 80%
- 优先使用已渲染的文本层，避免重复解析
- 智能高亮算法，正确处理跨 span 匹配
- 自动滚动到匹配位置，提升交互体验

---

## 🚀 v0.6.0 (2025.12.20)

#### ✨ 新增功能

**📄 PDF 阅读支持**
- **完整 PDF 阅读器** - 基于 PDF.js 的专业 PDF 阅读器，支持缩放（25%-400%）、旋转、页面跳转
- **虚拟滚动优化** - 优先级队列 + 虚拟滚动技术，大幅提升大文件加载速度和性能
- **全文搜索** - 支持 PDF 全文搜索，高亮显示搜索结果，快速定位内容
- **元数据解析** - 自动提取 PDF 标题、作者、页数等元数据信息
- **工具栏交互** - 支持工具栏折叠/展开、拖动调整位置、边缘检测防止超出视口

**🖊️ PDF 高级标注**
- **墨迹标注** - 支持手绘墨迹标注，可选 7 种颜色、调节粗细（1-10px）、橡皮擦功能
- **形状标注** - 支持矩形、圆形、三角形标注，可选颜色、粗细、拖拽调整大小
- **形状标注复制** - 支持复制形状标注到思源笔记，自动生成格式化链接
- **矢量存储** - 墨迹和形状标注存储为坐标点数据（JSON），不占用额外存储空间
- **智能渲染** - 阅读时使用低分辨率 Canvas 实时渲染预览，复制时动态生成高清图片（2x DPR）

**📚 词典卡包系统**
- **词典卡包** - 查词结果可一键加入卡包，便于复习和管理
- **阅读界面标注** - 卡包词汇在阅读界面显示 🌐 图标，点击查看详情
- **实时同步** - 添加/删除卡包后立即更新阅读界面和数据文件（`deck.json`）

**📝 EPUB 脚注增强**
- **智能脚注识别** - 自动识别 EPUB 脚注链接（`epub:type="noteref"` / `role="doc-noteref"`）
- **点击弹窗显示** - 点击脚注链接弹窗显示内容而非跳转，显示脚注类型、ID 和完整内容
- **Tooltip 显示** - 鼠标悬停显示 tooltip 预览，支持滚动查看长内容

**🎨 统一 Tooltip 系统**
- **三类 Tooltip** - 统一笔记（蓝色 📝）、词典（紫色 🌐）、脚注（红色 📌）的显示样式
- **视觉效果** - 三层阴影、毛玻璃背景、渐变头部、图标发光效果
- **边缘检测** - 自动检测视口边缘，防止 tooltip 超出屏幕
- **智能交互** - 鼠标可进入 tooltip 内部，支持滚动和复制内容

**📖 TXT 解析增强**
- **智能编码检测** - 自动检测 UTF-8/UTF-16/GBK 编码，支持 BOM 标识
- **章节识别优化** - 支持多种章节格式识别（第X章、Chapter X、数字序号、【标题】）
- **容错处理** - 编码检测失败时自动降级到 GBK，确保文件可读

#### 🔧 界面优化

**📋 标注面板重构**
- **统一标注面板** - 重构 `MarkPanel.vue`，统一 PDF/EPUB/TXT 三种格式的标注交互
- **统一编辑 UI** - 统一标注、编辑、显示窗口，使用一套结构和样式
- **统一标注显示** - 墨迹标注和形状标注统一显示在标注页面，支持删除、编辑、点击展开查看详情
- **实时编辑** - 支持标注文本、笔记、颜色、样式的实时修改和保存
- **精确管理** - 使用 `data-mark-id` 精确定位和管理每个标注及其图标
- **7色4样式** - 红🔴橙🟠黄🟡绿🟢粉🩷蓝🔵紫🟣 + 高亮/下划线/边框/波浪线
- **交互优化** - 优化标注选择、编辑、删除等操作的交互流程

**🎯 标注管理器优化**
- **统一管理** - `MarkManager.ts` 统一管理 PDF/EPUB/TXT 三种格式的标注逻辑
- **精确操作** - 添加/更新/删除标注时精确操作单个标注，不影响其他标注
- **数据同步** - 标注数据与词典卡包（`deck.json`）实时同步

**📚 书架元数据增强**
- **智能解析** - 优化 EPUB/MOBI/AZW3/FB2/CBZ 元数据解析逻辑
- **完整信息** - 自动提取书名、作者、简介、章节、封面等完整信息
- **缓存优化** - 元数据缓存机制，减少重复解析提升性能
- **进度刷新** - 优化书架进度显示，实时同步阅读进度

#### 🐛 问题修复

- **✅ 标注错位** - 修复删除标注后其他标注位置错位的问题
- **✅ 图标残留** - 修复删除标注后图标未清除导致残留的问题
- **✅ 卡包同步** - 修复删除词典卡包后 `deck.json` 文件未同步更新的问题
- **✅ Tooltip 边缘** - 修复 tooltip 超出视口边缘显示不全的问题
- **✅ 脚注跳转** - 修复 EPUB 脚注点击后直接跳转而非显示内容的问题
- **✅ 高亮错位** - 修复增删标注后文本高亮样式错位的问题
- **✅ 进度保存** - 修复阅读进度保存不准确的问题，确保进度实时同步
- **✅ 书架进度** - 修复书架进度显示不更新的问题，优化进度刷新机制

---

## � v0.数5.0 (2025.12.12)

### ✨ 核心功能
- **📚 阅读引擎升级** - 完全替换为 foliate-js，支持 EPUB、MOBI、PDF、TXT、在线小说
- **⌨️ 快捷键翻页** - 支持方向键、PageUp/Down、空格键快捷翻页
- **🎹 自定义快捷键** - 支持思源自定义快捷键（上一页、下一页、切换书签）
- **� 智架能链接跳转** - 支持 `sireader://` 协议，点击链接自动跳转到指定位置，避免重复打开
- **📚 卡包功能** - 支持词汇卡包管理，便于学习和复习
- **📖 词典系统** - 支持 StarDict/MDict 离线词典和在线词典，选中文本即可查词
- **🌐 AI 翻译** - 集成思源 AI 翻译和查词功能

### 📚 书架与搜索
- **� 本地导步入** - 支持选择本地 EPUB/MOBI/PDF/TXT 文件导入书架
- **🔍 智能搜索** - 支持按书名、作者搜索，多种排序方式（时间/书名/作者/更新）
- **📋 多视图** - 支持网格、列表、简洁三种显示模式
- **�  书源搜索** - 支持多书源并发搜索，流式显示结果，一键添加到书架
- **�  更新检查** - 一键检查所有在线书籍更新
- **�  元数据解析** - 自动解析 EPUB 元数据（书名、作者、简介、章节、封面）

### � 阅读与标注
- **� 目录导航** - 使用 foliate-js 原生目录，支持搜索和智能定位
- **🔖 书签管理** - 添加、删除、跳转书签
- **🌈 7色标注** - 红🔴橙🟠黄🟡绿🟢粉🩷蓝🔵紫🟣，支持添加笔记
- **🎨 4种样式** - 高亮、下划线、边框、波浪线，自由组合
- **🔍 颜色筛选**（待支持） - 按颜色筛选标注，批量管理
- **💾 持久化** - 标注数据独立存储，使用 CFI 精确定位

### 🎨 界面与设置
- **⚙️ 设置面板** - 全新设计，分类清晰：通用、外观、词典
- **📋 侧边栏** - 优化按钮顺序：书架→搜索→卡包→目录→书签→标注→笔记→通用→样式→词典
- **🎨 主题系统** - 统一使用思源主题色，完美融入界面
- **🎨 外观设置** - 字体、字号、字距、行距、段落间距、首行缩进全面可调
- **📏 布局设置** - 左右边距、上下边距、列间距、页眉页脚高度精细控制
- **🌈 视觉效果** - 亮度、对比度、褐色、饱和度、反色滤镜
- **📖 阅读模式** - 单页/双页、滑动/滚动翻页、目录左右切换

### 🔗 链接与复制
- **📋 格式化链接** - 支持自定义模板，默认使用思源 callout 格式
- **🎯 精准定位** - 使用 CFI 精确定位到书籍位置
- **📖 章节识别** - 自动识别当前章节，生成包含章节信息的链接
- **🔗 智能跳转** - 点击链接自动检测已打开书籍，直接跳转

### ⚡ 性能与优化
- **� 架构优化*** - 业务逻辑移至 composable，组件更清晰
- **� 响应式**  - 设置修改实时生效，无需刷新
- **💾 智能缓存** - 缓存书籍信息，减少重复加载
- **🎯 函数式编程** - 使用 reduce/map/filter 简化代码
- **� 类型安全*** - 完善 TypeScript 类型定义

### 🐛 问题修复
- **✅ 字体设置** - 修复字体不生效问题（使用完整 URL 路径）
- **✅ 主题应用** - 修复主题不应用到整个 tab 的问题
- **✅ 响应式更新** - 修复设置更新后阅读界面不响应
- **✅ 章节获取** - 修复章节信息无法正确获取
- **✅ 作者格式化** - 支持字符串/对象/数组多种格式
- **✅ 链接编码** - 修复中文链接编码问题
- **✅ 国际化** - 修复 tooltip 显示英文的问题
- **✅ 封面解析** - 修复 EPUB 封面解析失败导致循环重试的问题，失败时自动使用文字封面
- **✅ 快捷键冲突** - 修复快捷键在编辑时仍然生效的问题，仅在阅读时响应

---

### � v局0.2.7 (2025.11.29)
#### ✨ 新增功能
- **� 阅自定义书源** - 支持通过思源代码片段配置自定义书源，极限精简设计
- **🔍 书源搜索** - 支持多书源并发搜索，智能聚合结果
- **📖 在线阅读** - 支持在线阅读网络小说，章节导航流畅
- **� 格EPUB导出** - 支持将在线小说导出为标准EPUB格式
#### 🛠️ 功能优化
- **⚡ 极限精简** - 借鉴mplayer设计，通过window对象读取配置，零延迟
- **🎯 调试增强** - 添加详细的控制台日志，便于排查问题
- **📋 书源管理** - 11个测试书源（古登堡、追书、SF轻小说、起点等）
- **🔧 规则引擎** - 支持CSS选择器、XPath、JSONPath、正则表达式
#### � 文档化完善
- **📚 调试指南** - 完整的调试步骤和常见问题解决方案（DEBUG-BOOKSOURCE.md）
- **�  示例配置** - 提供11个测试书源示例（docs/siyuan-book-sources.js）

---

### � v0修.3.0 (2025.11.29)
#### ✨ 新增功能
- **🎯 目录钉住** - 目录面板支持钉住功能，钉住后自动调整阅读区域宽度，避免内容遮挡
- **📍 目录位置切换** - 支持左侧/右侧目录位置实时切换，设置后立即生效无需刷新
- **📄 单页双页显示** - 优化显示模式，支持单页/双页视图切换，阅读体验更灵活
- **⚙️ 文档绑定设置** - 目录面板新增设置功能，可为当前书籍重新绑定思源笔记文档
- **🔍 智能文档搜索** - 设置界面支持文档搜索选择，输入关键词快速定位目标文档
- **🔤 文本自定义设置** - 新增字体选择(默认/衬线/无衬线/微软雅黑/宋体/楷体)*、字号调节(12-32px)、字距控制  
  *注：字体效果可能不生效
- **📏 段落排版设置** - 支持行距调节(1.0-3.0倍)、段落间距设置(0-2em)、首行缩进控制(0-2em)
- **📋 页面布局设置** - 可调节左右边距(0-100px)、上下边距(0-80px)、连续滚动开关、一键恢复默认

#### 🛠️ 架构重构
- **� 设置义面板重构** - 重新设计设置界面，划分为界面、外观、标注三大模块
- **⚡ 响应式更新机制** - 统一所有设置项的响应式更新逻辑，修改设置立即生效
- **🎨 样式应用优化** - 修复翻页后主题样式回退问题，确保样式持久应用

#### �  问题修复
- **✅ 修复** - 翻页后主题回到旧样式的缓存问题
- **✅ 修复** - 设置更新不能及时响应的问题  
- **✅ 修复** - 目录钉住后内容区域布局错位问题
- **✅ 移除** - 已废弃的翻页方式设置，简化用户界面

---

### 📦 v0.2.6 (2025.11.27)
#### ✨ 新增功能
- **💡 笔记功能** - 支持为书籍内容添加详细笔记，记录阅读心得
- **✏️ 编辑功能** - 可编辑已有的笔记和标注内容，支持实时修改
- **🎯 智能标注** - 支持7种颜色标注（红🔴橙🟠黄🟡绿🟢粉🩷蓝🔵紫🟣），一键切换
- **📝 笔记管理** - 统一的笔记输入框，支持数字输入、删除和外部点击关闭
#### �️ 功能优化
- **⚙️ 设置保存逻辑** - 修复Vue响应式对象序列化问题，确保配置正确保存
- **📋 文档选择优化** - 搜索结果为单个时自动选择并保存，提升使用体验
- **🎨 UI组件统一** - 颜色选择器和笔记输入框使用统一的创建逻辑
- **� 性能提升*设* - 缓存机制优化，减少重复查询，提升响应速度
#### 🐛 问题修复
- **✅ 修复** - 标注颜色修改不生效的问题
- **✅ 修复** - 设置保存后重新打开丢失的问题
- **✅ 修复** - 文档选择结果唯一时无法触发保存的问题
