# 思阅 SiReader - 更新日志

---

## 🚀 v0.6.3 (2025.12.24)

#### 📚 书架功能增强

- **✅ 文字溢出修复** - 修复书架列表视图和简洁视图文字溢出的问题，确保书名和作者信息完整显示
- **📊 新增排序方式** - 新增"最近添加"、"最近阅读"、"阅读进度"三种排序方式，方便快速找到想看的书
- **💾 状态持久化** - 书架排序方式、筛选标签、视图模式自动保存到本地存储，下次打开保持上次设置

#### 🖊️ PDF 形状标注增强

- **🎨 填充功能** - 新增形状标注填充功能，支持对矩形、圆形、三角形进行颜色填充（实心/空心切换）
- **📝 自动弹窗** - 形状标注完成后自动弹出编辑备注窗口，可立即添加笔记说明
- **🎯 智能交互** - 优化墨迹标注和形状标注交互逻辑，点击工具栏折叠按钮自动退出编辑模式

#### 🔗 PDF 链接与跳转优化

- **📍 精准定位** - 修改 PDF 链接格式，使用页码和矩形坐标精确定位，跳转更准确
- **✨ 闪烁提示** - 增加跳转后高亮闪烁效果，更明显地标识目标位置
- **🔄 统一逻辑** - 统一跳转高亮逻辑和复制方法，阅读界面和标注界面行为一致

#### ⚡ PDF 渲染优化

- **🎯 重写渲染** - 重写 PDF 渲染方法，修复渲染不及时、标注错位等问题
- **📐 坐标转换** - 优化 PDF 坐标系统转换逻辑，确保缩放、旋转后标注位置准确
- **🖼️ Canvas 管理** - 改进 Canvas 层管理，缩放后自动重新创建绘图器，避免坐标错位

## 🚀 v0.6.2 (2025.12.21)

#### 🐛 问题修复

- **✅ 书籍数据文件** - 修复书籍异常关闭时对应数据文件重复创建的问题
- **✅ 标签页响应** - 增加标签页切换响应式切换目录、书签、标注、笔记功能
- **✅ 文件加载优化** - 统一 PDF/EPUB/TXT 文件加载逻辑，使用 `arrayBuffer()` 替代 `blob()` 避免大文件加载失败
- **✅ 图片错误处理** - EPUB 加载失败的图片自动隐藏，不显示破损图标
- **✅ 移动端 z-index** - 修复移动端阅读器容器 z-index 过高遮挡思源顶部栏（返回按钮和菜单）的问题
- **✅ 控制栏显示** - 优化底部控制栏显示逻辑，确保加载失败时也能显示关闭按钮
- **✅ 标注遮罩层** - 降低标注遮罩层和卡片的 z-index，确保控制栏始终在最上层可点击
- **✅ 组件卸载** - 修复组件卸载时访问 null 引用导致的报错

#### ✨ 移动端支持（实验性）

- **📱 移动端阅读** - 初步支持移动端阅读，PDF 打开正常，EPUB/TXT 可能存在问题
- **👆 手势翻页** - 支持左右滑动翻页，最小滑动距离 50px，自动过滤垂直滑动
- **💾 位置记忆** - 移动端自动保存和恢复阅读位置（CFI 或页码）
- **🔙 返回支持** - 监听浏览器返回按钮，自动触发阅读器关闭事件
- **📱 侧边栏入口** - 移动端侧边栏添加思阅图标入口，点击打开设置面板

#### ⚡ 代码优化

- **🔄 位置管理** - 统一阅读位置保存和恢复逻辑，代码更简洁
- **📂 文件加载** - 统一所有格式的文件加载流程，提升稳定性
- **🏷️ 标签切换** - 优化标签页切换监听机制
- **🎯 整体精简** - 删除冗余代码，提升性能和可维护性

---
## 🚀 v0.6.1 (2025.12.21)

#### 🐛 问题修复

- **✅ PDF 标注位置** - 修复 PDF 选中文字标注后高亮位置不在选中文字上的问题，统一坐标系统使用 `x/y/w/h` 格式
- **✅ 卡包高亮** - 修复 PDF 选词加入卡包后没有紫色高亮的问题，扩展卡包数据结构支持 `page` 和 `rects` 字段
- **✅ 笔记 Tooltip** - 统一标注笔记和形状标注笔记的 tooltip 显示逻辑，鼠标悬停显示完整笔记内容
- **✅ 卡包定位** - 修复卡包页面点击定位提示"未保存位置信息"的问题，支持 PDF 格式的 `page` 字段定位
- **✅ 链接格式说明** - 在 i18n 文件中添加"笔记"和"截图"变量说明，完善复制设置的可用变量提示

#### ⚡ 性能优化

**PDF 加载优化**
- 启用字体渲染和 WebGL 硬件加速，大幅提升渲染速度
- 优化 Canvas 上下文和渲染分辨率，减少像素计算量
- 文本层异步加载，不阻塞页面渲染
- 减小预加载范围，降低内存占用

**PDF 搜索优化**
- 文本缓存机制，第二次搜索速度提升 80%
- 优先使用已渲染的文本层，避免重复解析
- 智能高亮算法，正确处理跨 span 匹配
- 自动滚动到匹配位置，提升交互体验

---

## 🚀 v0.6.0 (2025.12.20)

#### ✨ 新增功能

**📄 PDF 阅读支持**
- **完整 PDF 阅读器** - 基于 PDF.js 的专业 PDF 阅读器，支持缩放（25%-400%）、旋转、页面跳转
- **虚拟滚动优化** - 优先级队列 + 虚拟滚动技术，大幅提升大文件加载速度和性能
- **全文搜索** - 支持 PDF 全文搜索，高亮显示搜索结果，快速定位内容
- **元数据解析** - 自动提取 PDF 标题、作者、页数等元数据信息
- **工具栏交互** - 支持工具栏折叠/展开、拖动调整位置、边缘检测防止超出视口

**🖊️ PDF 高级标注**
- **墨迹标注** - 支持手绘墨迹标注，可选 7 种颜色、调节粗细（1-10px）、橡皮擦功能
- **形状标注** - 支持矩形、圆形、三角形标注，可选颜色、粗细、拖拽调整大小
- **形状标注复制** - 支持复制形状标注到思源笔记，自动生成格式化链接
- **矢量存储** - 墨迹和形状标注存储为坐标点数据（JSON），不占用额外存储空间
- **智能渲染** - 阅读时使用低分辨率 Canvas 实时渲染预览，复制时动态生成高清图片（2x DPR）

**📚 词典卡包系统**
- **词典卡包** - 查词结果可一键加入卡包，便于复习和管理
- **阅读界面标注** - 卡包词汇在阅读界面显示 🌐 图标，点击查看详情
- **实时同步** - 添加/删除卡包后立即更新阅读界面和数据文件（`deck.json`）

**📝 EPUB 脚注增强**
- **智能脚注识别** - 自动识别 EPUB 脚注链接（`epub:type="noteref"` / `role="doc-noteref"`）
- **点击弹窗显示** - 点击脚注链接弹窗显示内容而非跳转，显示脚注类型、ID 和完整内容
- **Tooltip 显示** - 鼠标悬停显示 tooltip 预览，支持滚动查看长内容

**🎨 统一 Tooltip 系统**
- **三类 Tooltip** - 统一笔记（蓝色 📝）、词典（紫色 🌐）、脚注（红色 📌）的显示样式
- **视觉效果** - 三层阴影、毛玻璃背景、渐变头部、图标发光效果
- **边缘检测** - 自动检测视口边缘，防止 tooltip 超出屏幕
- **智能交互** - 鼠标可进入 tooltip 内部，支持滚动和复制内容

**📖 TXT 解析增强**
- **智能编码检测** - 自动检测 UTF-8/UTF-16/GBK 编码，支持 BOM 标识
- **章节识别优化** - 支持多种章节格式识别（第X章、Chapter X、数字序号、【标题】）
- **容错处理** - 编码检测失败时自动降级到 GBK，确保文件可读

#### 🔧 界面优化

**📋 标注面板重构**
- **统一标注面板** - 重构 `MarkPanel.vue`，统一 PDF/EPUB/TXT 三种格式的标注交互
- **统一编辑 UI** - 统一标注、编辑、显示窗口，使用一套结构和样式
- **统一标注显示** - 墨迹标注和形状标注统一显示在标注页面，支持删除、编辑、点击展开查看详情
- **实时编辑** - 支持标注文本、笔记、颜色、样式的实时修改和保存
- **精确管理** - 使用 `data-mark-id` 精确定位和管理每个标注及其图标
- **7色4样式** - 红🔴橙🟠黄🟡绿🟢粉🩷蓝🔵紫🟣 + 高亮/下划线/边框/波浪线
- **交互优化** - 优化标注选择、编辑、删除等操作的交互流程

**🎯 标注管理器优化**
- **统一管理** - `MarkManager.ts` 统一管理 PDF/EPUB/TXT 三种格式的标注逻辑
- **精确操作** - 添加/更新/删除标注时精确操作单个标注，不影响其他标注
- **数据同步** - 标注数据与词典卡包（`deck.json`）实时同步

**📚 书架元数据增强**
- **智能解析** - 优化 EPUB/MOBI/AZW3/FB2/CBZ 元数据解析逻辑
- **完整信息** - 自动提取书名、作者、简介、章节、封面等完整信息
- **缓存优化** - 元数据缓存机制，减少重复解析提升性能
- **进度刷新** - 优化书架进度显示，实时同步阅读进度

#### 🐛 问题修复

- **✅ 标注错位** - 修复删除标注后其他标注位置错位的问题
- **✅ 图标残留** - 修复删除标注后图标未清除导致残留的问题
- **✅ 卡包同步** - 修复删除词典卡包后 `deck.json` 文件未同步更新的问题
- **✅ Tooltip 边缘** - 修复 tooltip 超出视口边缘显示不全的问题
- **✅ 脚注跳转** - 修复 EPUB 脚注点击后直接跳转而非显示内容的问题
- **✅ 高亮错位** - 修复增删标注后文本高亮样式错位的问题
- **✅ 进度保存** - 修复阅读进度保存不准确的问题，确保进度实时同步
- **✅ 书架进度** - 修复书架进度显示不更新的问题，优化进度刷新机制

---

## � v0.数5.0 (2025.12.12)

### ✨ 核心功能
- **📚 阅读引擎升级** - 完全替换为 foliate-js，支持 EPUB、MOBI、PDF、TXT、在线小说
- **⌨️ 快捷键翻页** - 支持方向键、PageUp/Down、空格键快捷翻页
- **🎹 自定义快捷键** - 支持思源自定义快捷键（上一页、下一页、切换书签）
- **� 智架能链接跳转** - 支持 `sireader://` 协议，点击链接自动跳转到指定位置，避免重复打开
- **📚 卡包功能** - 支持词汇卡包管理，便于学习和复习
- **📖 词典系统** - 支持 StarDict/MDict 离线词典和在线词典，选中文本即可查词
- **🌐 AI 翻译** - 集成思源 AI 翻译和查词功能

### 📚 书架与搜索
- **� 本地导步入** - 支持选择本地 EPUB/MOBI/PDF/TXT 文件导入书架
- **🔍 智能搜索** - 支持按书名、作者搜索，多种排序方式（时间/书名/作者/更新）
- **📋 多视图** - 支持网格、列表、简洁三种显示模式
- **�  书源搜索** - 支持多书源并发搜索，流式显示结果，一键添加到书架
- **�  更新检查** - 一键检查所有在线书籍更新
- **�  元数据解析** - 自动解析 EPUB 元数据（书名、作者、简介、章节、封面）

### � 阅读与标注
- **� 目录导航** - 使用 foliate-js 原生目录，支持搜索和智能定位
- **🔖 书签管理** - 添加、删除、跳转书签
- **🌈 7色标注** - 红🔴橙🟠黄🟡绿🟢粉🩷蓝🔵紫🟣，支持添加笔记
- **🎨 4种样式** - 高亮、下划线、边框、波浪线，自由组合
- **🔍 颜色筛选**（待支持） - 按颜色筛选标注，批量管理
- **💾 持久化** - 标注数据独立存储，使用 CFI 精确定位

### 🎨 界面与设置
- **⚙️ 设置面板** - 全新设计，分类清晰：通用、外观、词典
- **📋 侧边栏** - 优化按钮顺序：书架→搜索→卡包→目录→书签→标注→笔记→通用→样式→词典
- **🎨 主题系统** - 统一使用思源主题色，完美融入界面
- **🎨 外观设置** - 字体、字号、字距、行距、段落间距、首行缩进全面可调
- **📏 布局设置** - 左右边距、上下边距、列间距、页眉页脚高度精细控制
- **🌈 视觉效果** - 亮度、对比度、褐色、饱和度、反色滤镜
- **📖 阅读模式** - 单页/双页、滑动/滚动翻页、目录左右切换

### 🔗 链接与复制
- **📋 格式化链接** - 支持自定义模板，默认使用思源 callout 格式
- **🎯 精准定位** - 使用 CFI 精确定位到书籍位置
- **📖 章节识别** - 自动识别当前章节，生成包含章节信息的链接
- **🔗 智能跳转** - 点击链接自动检测已打开书籍，直接跳转

### ⚡ 性能与优化
- **� 架构优化*** - 业务逻辑移至 composable，组件更清晰
- **� 响应式**  - 设置修改实时生效，无需刷新
- **💾 智能缓存** - 缓存书籍信息，减少重复加载
- **🎯 函数式编程** - 使用 reduce/map/filter 简化代码
- **� 类型安全*** - 完善 TypeScript 类型定义

### 🐛 问题修复
- **✅ 字体设置** - 修复字体不生效问题（使用完整 URL 路径）
- **✅ 主题应用** - 修复主题不应用到整个 tab 的问题
- **✅ 响应式更新** - 修复设置更新后阅读界面不响应
- **✅ 章节获取** - 修复章节信息无法正确获取
- **✅ 作者格式化** - 支持字符串/对象/数组多种格式
- **✅ 链接编码** - 修复中文链接编码问题
- **✅ 国际化** - 修复 tooltip 显示英文的问题
- **✅ 封面解析** - 修复 EPUB 封面解析失败导致循环重试的问题，失败时自动使用文字封面
- **✅ 快捷键冲突** - 修复快捷键在编辑时仍然生效的问题，仅在阅读时响应

---

### � v局0.2.7 (2025.11.29)
#### ✨ 新增功能
- **� 阅自定义书源** - 支持通过思源代码片段配置自定义书源，极限精简设计
- **🔍 书源搜索** - 支持多书源并发搜索，智能聚合结果
- **📖 在线阅读** - 支持在线阅读网络小说，章节导航流畅
- **� 格EPUB导出** - 支持将在线小说导出为标准EPUB格式
#### 🛠️ 功能优化
- **⚡ 极限精简** - 借鉴mplayer设计，通过window对象读取配置，零延迟
- **🎯 调试增强** - 添加详细的控制台日志，便于排查问题
- **📋 书源管理** - 11个测试书源（古登堡、追书、SF轻小说、起点等）
- **🔧 规则引擎** - 支持CSS选择器、XPath、JSONPath、正则表达式
#### � 文档化完善
- **📚 调试指南** - 完整的调试步骤和常见问题解决方案（DEBUG-BOOKSOURCE.md）
- **�  示例配置** - 提供11个测试书源示例（docs/siyuan-book-sources.js）

---

### � v0修.3.0 (2025.11.29)
#### ✨ 新增功能
- **🎯 目录钉住** - 目录面板支持钉住功能，钉住后自动调整阅读区域宽度，避免内容遮挡
- **📍 目录位置切换** - 支持左侧/右侧目录位置实时切换，设置后立即生效无需刷新
- **📄 单页双页显示** - 优化显示模式，支持单页/双页视图切换，阅读体验更灵活
- **⚙️ 文档绑定设置** - 目录面板新增设置功能，可为当前书籍重新绑定思源笔记文档
- **🔍 智能文档搜索** - 设置界面支持文档搜索选择，输入关键词快速定位目标文档
- **🔤 文本自定义设置** - 新增字体选择(默认/衬线/无衬线/微软雅黑/宋体/楷体)*、字号调节(12-32px)、字距控制  
  *注：字体效果可能不生效
- **📏 段落排版设置** - 支持行距调节(1.0-3.0倍)、段落间距设置(0-2em)、首行缩进控制(0-2em)
- **📋 页面布局设置** - 可调节左右边距(0-100px)、上下边距(0-80px)、连续滚动开关、一键恢复默认

#### 🛠️ 架构重构
- **� 设置义面板重构** - 重新设计设置界面，划分为界面、外观、标注三大模块
- **⚡ 响应式更新机制** - 统一所有设置项的响应式更新逻辑，修改设置立即生效
- **🎨 样式应用优化** - 修复翻页后主题样式回退问题，确保样式持久应用

#### �  问题修复
- **✅ 修复** - 翻页后主题回到旧样式的缓存问题
- **✅ 修复** - 设置更新不能及时响应的问题  
- **✅ 修复** - 目录钉住后内容区域布局错位问题
- **✅ 移除** - 已废弃的翻页方式设置，简化用户界面

---

### 📦 v0.2.6 (2025.11.27)
#### ✨ 新增功能
- **💡 笔记功能** - 支持为书籍内容添加详细笔记，记录阅读心得
- **✏️ 编辑功能** - 可编辑已有的笔记和标注内容，支持实时修改
- **🎯 智能标注** - 支持7种颜色标注（红🔴橙🟠黄🟡绿🟢粉🩷蓝🔵紫🟣），一键切换
- **📝 笔记管理** - 统一的笔记输入框，支持数字输入、删除和外部点击关闭
#### �️ 功能优化
- **⚙️ 设置保存逻辑** - 修复Vue响应式对象序列化问题，确保配置正确保存
- **📋 文档选择优化** - 搜索结果为单个时自动选择并保存，提升使用体验
- **🎨 UI组件统一** - 颜色选择器和笔记输入框使用统一的创建逻辑
- **� 性能提升*设* - 缓存机制优化，减少重复查询，提升响应速度
#### 🐛 问题修复
- **✅ 修复** - 标注颜色修改不生效的问题
- **✅ 修复** - 设置保存后重新打开丢失的问题
- **✅ 修复** - 文档选择结果唯一时无法触发保存的问题
